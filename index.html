<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>FreeFlix - Stream Your Sources</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&display=swap");

      :root {
        --red: #e50914;
        --red-dark: #b20710;
        --red-light: #f74c42;
        --bg: #080808;
        --surface: #111111;
        --surface2: #1a1a1a;
        --border: rgba(229, 9, 20, 0.18);
        --text: #f0f0f0;
        --text-muted: #555;
      }

      *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

      body {
        font-family: 'DM Sans', sans-serif;
        background: var(--bg);
        color: var(--text);
        overflow-x: hidden;
      }

      body::before {
        content: '';
        position: fixed;
        inset: 0;
        background:
          radial-gradient(ellipse 80% 50% at 10% 20%, rgba(229,9,20,0.06) 0%, transparent 60%),
          radial-gradient(ellipse 60% 40% at 90% 80%, rgba(229,9,20,0.04) 0%, transparent 60%);
        pointer-events: none;
        z-index: 0;
      }

      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: var(--bg); }
      ::-webkit-scrollbar-thumb { background: var(--red); border-radius: 3px; }

      /* â”€â”€ HEADER â”€â”€ */
      .header {
        position: fixed;
        top: 0; left: 0; right: 0;
        z-index: 100;
        background: linear-gradient(180deg, rgba(8,8,8,0.98) 0%, rgba(8,8,8,0.9) 100%);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border);
        padding: 14px 24px;
      }

      .header-inner { max-width: 1400px; margin: 0 auto; display: flex; flex-direction: column; gap: 12px; }

      .header-top { display: flex; align-items: center; justify-content: space-between; }

      .logo {
        font-family: 'Bebas Neue', sans-serif;
        font-size: 2rem;
        letter-spacing: 4px;
        line-height: 1;
        text-decoration: none;
      }
      .logo .r { color: var(--red); }
      .logo .w { color: var(--text); }

      .stats-pill {
        font-size: 0.68rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1.5px;
        border: 1px solid rgba(255,255,255,0.07);
        padding: 5px 12px;
        border-radius: 20px;
        background: rgba(255,255,255,0.03);
      }

      .search-wrap { position: relative; }
      .search-input {
        width: 100%;
        background: var(--surface);
        border: 1px solid rgba(255,255,255,0.07);
        border-radius: 10px;
        padding: 11px 42px 11px 15px;
        color: var(--text);
        font-family: 'DM Sans', sans-serif;
        font-size: 0.875rem;
        transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
        outline: none;
      }
      .search-input::placeholder { color: var(--text-muted); }
      .search-input:focus {
        border-color: var(--red);
        box-shadow: 0 0 0 3px rgba(229,9,20,0.1);
        background: var(--surface2);
      }
      .search-icon {
        position: absolute;
        right: 13px; top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        pointer-events: none;
      }

      .filters {
        display: flex;
        gap: 6px;
        overflow-x: auto;
        padding-bottom: 2px;
        scrollbar-width: none;
      }
      .filters::-webkit-scrollbar { display: none; }

      .filter-sep { width: 1px; background: rgba(255,255,255,0.07); flex-shrink: 0; margin: 0 2px; }

      .filter-btn {
        flex-shrink: 0;
        padding: 6px 14px;
        border-radius: 7px;
        font-family: 'DM Sans', sans-serif;
        font-size: 0.78rem;
        font-weight: 600;
        border: 1px solid rgba(255,255,255,0.07);
        background: var(--surface);
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.18s ease;
        white-space: nowrap;
      }
      .filter-btn:hover { border-color: rgba(229,9,20,0.4); color: var(--text); background: var(--surface2); }
      .filter-btn.active { background: var(--red); border-color: var(--red); color: #fff; box-shadow: 0 3px 12px rgba(229,9,20,0.3); }

      /* â”€â”€ GRID â”€â”€ */
      .main {
        position: relative;
        z-index: 1;
        padding: 0 20px 80px;
        max-width: 1400px;
        margin: 0 auto;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      @media (min-width: 560px)  { .grid { grid-template-columns: repeat(3, 1fr); } }
      @media (min-width: 800px)  { .grid { grid-template-columns: repeat(4, 1fr); } }
      @media (min-width: 1060px) { .grid { grid-template-columns: repeat(5, 1fr); } }
      @media (min-width: 1300px) { .grid { grid-template-columns: repeat(6, 1fr); } }

      /* â”€â”€ CARD â”€â”€ */
      .card {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        cursor: pointer;
        aspect-ratio: 2/3;
        background: var(--surface);
        transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        animation: fadeUp 0.45s ease forwards;
        opacity: 0;
      }
      @keyframes fadeUp {
        from { opacity: 0; transform: translateY(16px); }
        to   { opacity: 1; transform: translateY(0); }
      }
      .card:hover {
        transform: scale(1.045) translateY(-5px);
        box-shadow: 0 20px 50px rgba(229,9,20,0.28), 0 6px 16px rgba(0,0,0,0.5);
        z-index: 2;
      }
      .card img {
        width: 100%; height: 100%;
        object-fit: cover;
        display: block;
        transition: transform 0.45s ease;
      }
      .card:hover img { transform: scale(1.07); }

      .card-overlay {
        position: absolute; inset: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.35) 45%, transparent 70%);
        opacity: 0;
        transition: opacity 0.28s ease;
        display: flex; flex-direction: column; justify-content: flex-end;
        padding: 14px;
      }
      .card:hover .card-overlay { opacity: 1; }

      .card-title {
        font-size: 0.8rem;
        font-weight: 700;
        color: #fff;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        margin-bottom: 7px;
      }

      .card-meta { display: flex; gap: 5px; align-items: center; flex-wrap: wrap; }

      .badge {
        font-size: 0.62rem; font-weight: 700;
        text-transform: uppercase; letter-spacing: 0.8px;
        padding: 3px 7px; border-radius: 4px;
        background: var(--red); color: #fff;
      }
      .badge-rating {
        font-size: 0.62rem; font-weight: 700;
        padding: 3px 7px; border-radius: 4px;
        background: rgba(255,215,0,0.12); color: #ffd700;
        border: 1px solid rgba(255,215,0,0.2);
      }

      .play-btn {
        position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%) scale(0.65);
        width: 48px; height: 48px;
        background: rgba(229,9,20,0.95);
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        opacity: 0;
        transition: all 0.28s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 0 28px rgba(229,9,20,0.55);
      }
      .card:hover .play-btn { opacity: 1; transform: translate(-50%, -50%) scale(1); }

      /* â”€â”€ SKELETON â”€â”€ */
      .skeleton {
        aspect-ratio: 2/3; border-radius: 10px;
        background: linear-gradient(90deg, #101010 0%, #1c1c1c 50%, #101010 100%);
        background-size: 400% 100%;
        animation: shimmer 1.8s ease infinite;
      }
      @keyframes shimmer { 0% { background-position: 100% 50%; } 100% { background-position: -100% 50%; } }

      /* â”€â”€ STATES â”€â”€ */
      .empty { text-align: center; padding: 80px 20px; color: var(--text-muted); }
      .empty-icon { font-size: 3.5rem; margin-bottom: 14px; }
      .empty h3 { font-size: 1.1rem; font-weight: 600; color: var(--text); margin-bottom: 6px; }
      .empty p { font-size: 0.875rem; }

      .error-box {
        background: rgba(229,9,20,0.07); border: 1px solid rgba(229,9,20,0.25);
        border-radius: 10px; padding: 18px 20px;
        color: #f87171; display: flex; align-items: center; gap: 10px; font-weight: 500; font-size: 0.875rem;
      }

      .load-wrap { display: flex; justify-content: center; padding: 28px 0; }
      .spinner {
        width: 22px; height: 22px;
        border: 2px solid rgba(229,9,20,0.2);
        border-top-color: var(--red);
        border-radius: 50%;
        animation: spin 0.7s linear infinite;
      }
      @keyframes spin { to { transform: rotate(360deg); } }

      .end-msg {
        text-align: center; padding: 28px 0;
        color: var(--text-muted); font-size: 0.82rem; font-weight: 500;
        display: flex; align-items: center; gap: 14px;
      }
      .end-msg::before, .end-msg::after {
        content: ''; flex: 1; height: 1px;
        background: linear-gradient(90deg, transparent, rgba(229,9,20,0.25), transparent);
      }

      /* â”€â”€ MODAL â”€â”€ */
      .modal-backdrop {
        position: fixed; inset: 0;
        background: rgba(0,0,0,0.82);
        backdrop-filter: blur(18px);
        z-index: 200;
        display: flex; align-items: center; justify-content: center;
        padding: 16px;
        animation: bfadeIn 0.22s ease;
      }
      @keyframes bfadeIn { from { opacity: 0; } to { opacity: 1; } }

      .modal {
        background: var(--surface);
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: 18px;
        width: 100%; max-width: 660px; max-height: 90vh;
        overflow-y: auto; position: relative;
        animation: mslide 0.32s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        scrollbar-width: none;
      }
      .modal::-webkit-scrollbar { display: none; }
      @keyframes mslide {
        from { opacity: 0; transform: translateY(36px) scale(0.95); }
        to   { opacity: 1; transform: translateY(0) scale(1); }
      }

      .modal-hero { position: relative; height: 300px; overflow: hidden; border-radius: 18px 18px 0 0; }
      .modal-hero img { width: 100%; height: 100%; object-fit: cover; }
      .modal-hero-grad {
        position: absolute; inset: 0;
        background: linear-gradient(to top, var(--surface) 0%, rgba(17,17,17,0.2) 60%, transparent 100%);
      }

      .modal-close {
        position: absolute; top: 14px; right: 14px;
        width: 34px; height: 34px;
        background: rgba(0,0,0,0.55); border: 1px solid rgba(255,255,255,0.1);
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        cursor: pointer; color: var(--text-muted); font-size: 0.9rem;
        transition: all 0.18s; z-index: 10;
      }
      .modal-close:hover { color: #fff; background: var(--red); border-color: var(--red); }

      .modal-body { padding: 4px 22px 26px; }

      .modal-title {
        font-family: 'Bebas Neue', sans-serif;
        font-size: 1.9rem; letter-spacing: 2px; color: #fff;
        margin-bottom: 10px; line-height: 1;
      }

      .modal-tags { display: flex; gap: 7px; flex-wrap: wrap; margin-bottom: 22px; }

      .tag { padding: 5px 11px; border-radius: 5px; font-size: 0.72rem; font-weight: 600; }
      .tag-type { background: var(--red); color: #fff; }
      .tag-rating { background: rgba(255,215,0,0.1); color: #ffd700; border: 1px solid rgba(255,215,0,0.18); }
      .tag-year { background: rgba(255,255,255,0.06); color: var(--text-muted); border: 1px solid rgba(255,255,255,0.07); }

      .section-label {
        font-size: 0.67rem; font-weight: 700; text-transform: uppercase;
        letter-spacing: 1.8px; color: var(--text-muted);
        margin-bottom: 10px;
        display: flex; align-items: center; gap: 8px;
      }
      .section-label::after { content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.05); }

      .modal-section { margin-bottom: 18px; }

      .provider-row {
        display: flex; align-items: center; justify-content: space-between;
        padding: 11px 13px; border-radius: 9px;
        background: var(--surface2); border: 1px solid rgba(255,255,255,0.04);
        margin-bottom: 7px; transition: all 0.18s; text-decoration: none;
      }
      .provider-row:hover { border-color: rgba(229,9,20,0.35); background: rgba(229,9,20,0.04); transform: translateX(3px); }

      .provider-left { display: flex; align-items: center; gap: 11px; }
      .provider-img {
        width: 34px; height: 34px; border-radius: 7px; object-fit: cover;
        background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07); flex-shrink: 0;
      }
      .provider-name { font-weight: 600; font-size: 0.875rem; color: var(--text); }

      .watch-link {
        font-size: 0.78rem; font-weight: 700; color: var(--red-light);
        display: flex; align-items: center; gap: 4px; white-space: nowrap; transition: gap 0.18s;
      }
      .provider-row:hover .watch-link { gap: 7px; }

      .no-sources { text-align: center; padding: 28px; color: var(--text-muted); font-size: 0.875rem; }
    </style>
  </head>

  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useState, useRef, useCallback } = React;

      // â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const API_BASE_URL =
        (window.ENV && window.ENV.API_URL)
          ? window.ENV.API_URL
          : 'https://freeflix-production.up.railway.app/';

      const TMDB = (path, size = 'w500') =>
        path ? `https://image.tmdb.org/t/p/${size}${path}` : '';

      const PER_PAGE = 18;

      // â”€â”€â”€ PROVIDER ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function ProviderRow({ src }) {
        return (
          <a href={src.provider_url || '#'} target="_blank" rel="noopener noreferrer" className="provider-row">
            <div className="provider-left">
              <img
                src={TMDB(src.provider_image, 'w92')}
                alt={src.provider}
                className="provider-img"
                onError={e => { e.target.style.display = 'none'; }}
              />
              <span className="provider-name">{src.provider}</span>
            </div>
            <span className="watch-link">
              Watch
              <svg width="13" height="13" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M14 5l7 7m0 0l-7 7m7-7H3" />
              </svg>
            </span>
          </a>
        );
      }

      // â”€â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function Modal({ item, onClose }) {
        if (!item) return null;

        useEffect(() => {
          const fn = e => { if (e.key === 'Escape') onClose(); };
          document.addEventListener('keydown', fn);
          // Prevent body scroll while modal open
          document.body.style.overflow = 'hidden';
          return () => {
            document.removeEventListener('keydown', fn);
            document.body.style.overflow = '';
          };
        }, []);

        const grouped = (item.source_info || []).reduce((acc, src) => {
          const k = src.payment || 'other';
          (acc[k] = acc[k] || []).push(src);
          return acc;
        }, {});

        const SECTIONS = [
          { key: 'flatrate', label: 'Included with subscription' },
          { key: 'rent',     label: 'Rent' },
          { key: 'buy',      label: 'Buy' },
          { key: 'other',    label: 'Other' },
        ].filter(s => grouped[s.key]?.length > 0);

        return (
          <div className="modal-backdrop" onClick={onClose}>
            <div className="modal" onClick={e => e.stopPropagation()}>
              <div className="modal-hero">
                <img src={TMDB(item.image)} alt={item.name} />
                <div className="modal-hero-grad" />
                <button className="modal-close" onClick={onClose}>âœ•</button>
              </div>

              <div className="modal-body">
                <h2 className="modal-title">{item.name.replaceAll('_', ' ')}</h2>

                <div className="modal-tags">
                  <span className="tag tag-type">{item.type === 'movie' ? 'ğŸ¬ Movie' : 'ğŸ“º Series'}</span>
                  {item.rating && <span className="tag tag-rating">â­ {item.rating}/10</span>}
                  {item.year   && <span className="tag tag-year">{item.year}</span>}
                </div>

                {SECTIONS.length > 0 ? SECTIONS.map(({ key, label }) => (
                  <div key={key} className="modal-section">
                    <div className="section-label">{label}</div>
                    {grouped[key].map((src, i) => <ProviderRow key={i} src={src} />)}
                  </div>
                )) : (
                  <div className="no-sources">No streaming sources found for this title</div>
                )}
              </div>
            </div>
          </div>
        );
      }

      // â”€â”€â”€ CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function Card({ item, index, onClick, lastRef }) {
        return (
          <div
            className="card"
            ref={lastRef}
            onClick={onClick}
            style={{ animationDelay: `${(index % PER_PAGE) * 0.035}s` }}
          >
            <img src={TMDB(item.image)} alt={item.name} loading="lazy" />
            <div className="card-overlay">
              <div className="card-title">{item.name.replaceAll('_', ' ')}</div>
              <div className="card-meta">
                <span className="badge">{item.type}</span>
                {item.rating && <span className="badge-rating">â­ {item.rating}</span>}
              </div>
            </div>
            <div className="play-btn">
              <svg width="18" height="18" fill="white" viewBox="0 0 24 24">
                <path d="M8 5v14l11-7z" />
              </svg>
            </div>
          </div>
        );
      }

      // â”€â”€â”€ SKELETON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function SkeletonGrid({ count = PER_PAGE }) {
        return (
          <div className="grid">
            {Array.from({ length: count }).map((_, i) => <div key={i} className="skeleton" />)}
          </div>
        );
      }

      // â”€â”€â”€ APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function FreeFlix() {
        const [items, setItems]                 = useState([]);
        const [selected, setSelected]           = useState(null);
        const [loading, setLoading]             = useState(true);
        const [loadingMore, setLoadingMore]     = useState(false);
        const [error, setError]                 = useState(null);
        const [page, setPage]                   = useState(1);
        const [hasMore, setHasMore]             = useState(true);
        const [totalCount, setTotalCount]       = useState(0);
        const [sources, setSources]             = useState([]);

        const [search, setSearch]               = useState('');
        const [debouncedSearch, setDebounced]   = useState('');
        const [typeFilter, setTypeFilter]       = useState('all');
        const [sourceFilter, setSourceFilter]   = useState('all');

        const observerRef = useRef();
        const lastCardRef = useRef();

        // Debounce
        useEffect(() => {
          const t = setTimeout(() => setDebounced(search), 450);
          return () => clearTimeout(t);
        }, [search]);

        // Fetch
        const fetchItems = useCallback((pageNum, append = false, q = '') => {
          append ? setLoadingMore(true) : setLoading(true);
          setError(null);

          const params = new URLSearchParams({ page: pageNum, limit: PER_PAGE });
          if (q) params.set('search', q);

          fetch(`${API_BASE_URL}?${params}`)
            .then(res => {
              if (!res.ok) throw new Error(`Server responded with ${res.status}`);
              return res.json();
            })
            .then(data => {
              // â”€â”€ BUG FIX: safely handle different response shapes
              const incoming = Array.isArray(data)
                ? data
                : Array.isArray(data.content)
                  ? data.content
                  : [];

              const count = data.count ?? data.total ?? incoming.length;

              if (append) {
                setItems(prev => [...prev, ...incoming]);
              } else {
                setItems(incoming);
                setTotalCount(count);

                // Build provider list from first page results
                const seen = new Set();
                incoming.forEach(item =>
                  (item.source_info || []).forEach(s => seen.add(s.provider))
                );
                setSources([...seen].sort());
              }

              // If fewer items than requested, we've hit the end
              setHasMore(incoming.length === PER_PAGE);
            })
            .catch(err => {
              console.error('Fetch error:', err);
              setError('Could not reach the server. Please try again.');
            })
            .finally(() => {
              setLoading(false);
              setLoadingMore(false);
            });
        }, []);

        // Reset + fetch on filter/search change
        useEffect(() => {
          setPage(1);
          setItems([]);
          setHasMore(true);
          fetchItems(1, false, debouncedSearch);
        }, [debouncedSearch, typeFilter, sourceFilter, fetchItems]);

        // Load next page
        const loadMore = useCallback(() => {
          if (loadingMore || !hasMore || loading) return;
          const next = page + 1;
          setPage(next);
          fetchItems(next, true, debouncedSearch);
        }, [page, hasMore, loadingMore, loading, fetchItems, debouncedSearch]);

        // Infinite scroll observer
        useEffect(() => {
          observerRef.current = new IntersectionObserver(
            entries => { if (entries[0].isIntersecting) loadMore(); },
            { rootMargin: '350px' }
          );
          if (lastCardRef.current) observerRef.current.observe(lastCardRef.current);
          return () => observerRef.current?.disconnect();
        }, [loadMore]);

        // â”€â”€ CLIENT-SIDE FILTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // BUG FIX: previously items would flicker to "no content" when filter
        // changed before new data arrived. Now we only show empty state when
        // loading is fully done AND filtered result is truly empty.
        const filtered = items.filter(item => {
          if (typeFilter !== 'all' && item.type !== typeFilter) return false;
          if (sourceFilter !== 'all') {
            const providers = (item.source_info || []).map(s => s.provider);
            if (!providers.includes(sourceFilter)) return false;
          }
          return true;
        });

        const showEmpty = !loading && !loadingMore && !error && filtered.length === 0;

        // Dynamic header height for main padding
        const headerHeight = 'calc(178px + 16px)';

        return (
          <div style={{ minHeight: '100vh' }}>

            {/* â”€â”€ HEADER â”€â”€ */}
            <header className="header">
              <div className="header-inner">
                <div className="header-top">
                  <div className="logo"><span className="r">FREE</span><span className="w">FLIX</span></div>
                  {totalCount > 0 && (
                    <div className="stats-pill">{totalCount.toLocaleString()} titles</div>
                  )}
                </div>

                <div className="search-wrap">
                  <input
                    type="text"
                    className="search-input"
                    placeholder="Search movies & series..."
                    value={search}
                    onChange={e => setSearch(e.target.value)}
                  />
                  <svg className="search-icon" width="15" height="15" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                  </svg>
                </div>

                <div className="filters">
                  {[
                    { val: 'all',    label: 'All' },
                    { val: 'movie',  label: 'ğŸ¬ Movies' },
                    { val: 'series', label: 'ğŸ“º Series' },
                  ].map(({ val, label }) => (
                    <button
                      key={val}
                      className={`filter-btn ${typeFilter === val ? 'active' : ''}`}
                      onClick={() => setTypeFilter(val)}
                    >
                      {label}
                    </button>
                  ))}

                  {sources.length > 0 && (
                    <>
                      <div className="filter-sep" />
                      <button
                        className={`filter-btn ${sourceFilter === 'all' ? 'active' : ''}`}
                        onClick={() => setSourceFilter('all')}
                      >
                        All Sources
                      </button>
                      {sources.map(src => (
                        <button
                          key={src}
                          className={`filter-btn ${sourceFilter === src ? 'active' : ''}`}
                          onClick={() => setSourceFilter(src)}
                        >
                          {src}
                        </button>
                      ))}
                    </>
                  )}
                </div>
              </div>
            </header>

            {/* â”€â”€ MAIN â”€â”€ */}
            <main className="main" style={{ paddingTop: headerHeight }}>

              {loading && <SkeletonGrid count={PER_PAGE} />}

              {error && (
                <div className="error-box">
                  <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
                  </svg>
                  {error}
                </div>
              )}

              {!loading && !error && filtered.length > 0 && (
                <div className="grid">
                  {filtered.map((item, i) => (
                    <Card
                      key={`${item.name}-${i}`}
                      item={item}
                      index={i}
                      onClick={() => setSelected(item)}
                      lastRef={i === filtered.length - 1 ? lastCardRef : null}
                    />
                  ))}
                </div>
              )}

              {showEmpty && (
                <div className="empty">
                  <div className="empty-icon">ğŸ”</div>
                  <h3>No results found</h3>
                  <p>Try a different search term or clear your filters</p>
                </div>
              )}

              {loadingMore && (
                <div className="load-wrap"><div className="spinner" /></div>
              )}

              {!loading && !loadingMore && !hasMore && filtered.length > 0 && (
                <div className="end-msg">You've seen it all ğŸ¬</div>
              )}

            </main>

            {selected && <Modal item={selected} onClose={() => setSelected(null)} />}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<FreeFlix />);
    </script>
  </body>
</html>